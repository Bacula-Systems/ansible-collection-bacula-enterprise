- name: create volumes directory
  file:
    path: "{{ volumes_directory }}"
    state: directory
    owner: bacula
    group: disk
    mode: '0755'

- name: create conf.d/storage directory
  file:
    path: /opt/bacula/etc/conf.d/storage
    state: directory
    mode: '0770'
    owner: bacula
    group: bacula

- name: create empty file in the conf.d storage directory
  file:
    path: /opt/bacula/etc/conf.d/storage/empty.conf
    state: touch
    mode: '0770'
    owner: bacula
    group: bacula

- name: Modify the Storage name, if defined
  ansible.builtin.replace:
    path: /opt/bacula/etc/bacula-sd.conf
    after: 'Storage {'
    regexp: "{{ storage_hostname.split('.')[0] }}-sd"
    replace: "{{ storage_name }}"
  when: storage_name is defined

- name: include the line to include all configuration files in the conf.d/storage directory in the bacula-sd.conf file
  blockinfile:
    path: /opt/bacula/etc/bacula-sd.conf
    insertafter: EOF
    block: |
      @|"sh -c 'for f in /opt/bacula/etc/conf.d/storage/*.conf ; do echo @${f} ; done'"

- name: add the Director to the Standard Messages resource if director is a different host
  blockinfile:
    path: /opt/bacula/etc/bacula-sd.conf
    marker: "# {mark} Add Director to Standard Messages resource"
    insertafter: "^Messages"
    block: |
      director = {{ dir_hostname }} = all, !skipped, !restored, !saved
  when: dir_hostname is defined and dir_hostname != vm_name

- name: generate the autochanger resource definition to be included in the bacula-sd.conf file
  template:
    src: "autochanger_conf_in_bacula_sd.j2"
    dest: "/opt/bacula/etc/conf.d/storage/{{ storage_name }}-autochanger-devices.conf"
    owner: bacula
    group: bacula
    mode: '0660'

- name: get the Storage Daemon password used to communicate with Director in the bacula-sd.conf file
  shell: "grep ^[[:space:]]*Password -m 1 /opt/bacula/etc/bacula-sd.conf | tr -d ' ' | tr -d '\"' | cut -d \"=\" -f2"
  register: current_sd_password

- name: set the dir_sd_password
  set_fact:
    dir_sd_password: "{{ current_sd_password.stdout }}"

- name: include director in the bacula-sd.conf file if director is a different host
  template:
    src: "director_conf_in_bacula_sd.j2"
    dest: "/opt/bacula/etc/conf.d/storage/{{ director_name }}.conf"
    owner: root
    group: bacula
    mode: '0660'
  when: director_hostname is defined and storage_hostname != director_hostname
